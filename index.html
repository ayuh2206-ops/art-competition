<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Stroke - Art Competition</title>
    
    <!-- Error Handler -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            console.error("Global Error:", msg);
            if (msg.includes('permission-denied')) return true;
            const loader = document.getElementById('initial-loader');
            if (loader) loader.innerHTML = `<div style="color:#ef4444; text-align:center; padding:20px;">
                <p style="font-size:1.2em; font-weight:bold;">Something went wrong</p>
                <p style="font-size:0.8em; opacity:0.8;">${msg}</p>
                <p style="font-size:0.7em;">Check console for details.</p>
            </div>`;
            return false;
        };
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase Compat Scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-storage-compat.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Great+Vibes&family=Dancing+Script:wght@400;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">

    <style>
        .animate-fadeIn { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .editable-wrapper {
            position: relative;
            display: block; 
            transition: all 0.2s;
            width: 100%;
        }

        .editable-input {
            background: transparent;
            border: 1px dashed transparent;
            width: 100%;
            transition: all 0.2s;
        }

        .editable-wrapper:hover .editable-input.admin-active {
            border-color: #a855f7;
            background-color: rgba(255, 255, 255, 0.5);
        }

        .editable-wrapper:focus-within .editable-input.admin-active {
            outline: none;
            border-color: #a855f7;
            background-color: rgba(255, 255, 255, 0.9);
            box-shadow: 0 0 10px rgba(168, 85, 247, 0.2);
        }

        /* Toolbar */
        .format-toolbar {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            border: 1px solid #374151;
            padding: 6px;
            border-radius: 8px;
            display: flex;
            gap: 4px;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            margin-bottom: 5px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .editable-wrapper:hover .format-toolbar,
        .editable-wrapper:focus-within .format-toolbar {
            opacity: 1;
            visibility: visible;
        }

        .format-toolbar::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #1f2937 transparent transparent transparent;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        .font-artistic { font-family: 'Great Vibes', cursive; }
        .font-body { font-family: 'Playfair Display', serif; }
        .font-title { font-family: 'Cinzel', serif; }
        .font-modern { font-family: 'Montserrat', sans-serif; }
        .font-dance { font-family: 'Dancing Script', cursive; }

        #initial-loader {
            position: fixed;
            inset: 0;
            background: #111827;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #a855f7;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 1rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">

    <div id="initial-loader">
        <div class="spinner"></div>
        <p class="font-title tracking-widest text-sm">LOADING MASTER STROKE...</p>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyACH3hBDHmAGD6ubmloy3Xcdq2zbBEu5hY",
            authDomain: "art-competition-c8782.firebaseapp.com",
            projectId: "art-competition-c8782",
            storageBucket: "art-competition-c8782.firebasestorage.app",
            messagingSenderId: "877780594142",
            appId: "1:877780594142:web:96ddf84ea1c6d406b4414f",
            measurementId: "G-57FCM19J06"
        };

        // Initialize Firebase
        let app, auth, db, storage;
        try {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            storage = firebase.storage();
        } catch (e) {
            console.warn("Firebase failed to init:", e);
        }

        const APP_ID = typeof window.__app_id !== 'undefined' ? window.__app_id : 'master-stroke-default';
        const COLLECTION_NAME = 'masterStrokeData';
        const DOC_ID = 'siteContent';

        const { useState, useEffect, useRef } = React;

        // --- GLOBAL STYLES ---
        const glassClass = "bg-white/40 backdrop-blur-md border border-white/40 shadow-2xl rounded-xl text-gray-900";

        // --- ICONS ---
        const Icon = ({ name, className }) => {
            const icons = {
                Loader: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`${className} animate-spin`}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
                Lock: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
                Unlock: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>,
                UserPlus: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg>,
                User: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
                Phone: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>,
                Briefcase: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>,
                Menu: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>,
                X: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
                Plus: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></svg>,
                Bold: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14 12a4 4 0 0 0 0-8H6v8"/><path d="M15 20a4 4 0 0 0 0-8H6v8Z"/></svg>,
                Italic: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="19" x2="10" y1="4" y2="4"/><line x1="14" x2="5" y1="20" y2="20"/><line x1="15" x2="9" y1="4" y2="20"/></svg>,
                Alert: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
                Check: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"/></svg>
            };
            return icons[name] || null;
        };

        const createTextObj = (text, style = {}) => ({ text, style });

        const INITIAL_DATA = {
            header: {
                schoolName: createTextObj("Podar International School", { color: '#fde047', fontFamily: 'Cinzel', fontSize: '1.5rem', fontWeight: 'bold' }),
                title: createTextObj("MASTER STROKE", { color: '#ffffff', fontFamily: 'Cinzel', fontSize: '5rem', fontWeight: '900', textShadow: '2px 2px 4px rgba(0,0,0,0.5)' }),
                subtitle: createTextObj("Unleashing Creativity, One Stroke at a Time", { color: '#f3f4f6', fontFamily: 'Great Vibes', fontSize: '2rem' }),
                bgUrl: "https://cdn.pixabay.com/video/2016/09/21/5302-183786270_large.mp4",
                bgType: "video"
            },
            home: {
                bgUrl: "https://images.unsplash.com/photo-1513364776144-60967b0f800f?q=80&w=2071&auto=format&fit=crop",
                bgType: "image",
                intro: createTextObj("Greetings of the day!!", { fontFamily: 'Cinzel', fontSize: '1.5rem', borderBottom: '2px solid #9ca3af', paddingBottom: '0.5rem' }),
                quote: createTextObj("“A Painter has the UNIVERSE in his mind and hands” - Da Vinci", { fontFamily: 'Playfair Display', fontStyle: 'italic', fontSize: '1.25rem', fontWeight: 'bold' }),
                text1: createTextObj("Expressiveness is valuable because it helps us to understand emotions in general while contributing to the formation of an aesthetically satisfying whole.", { fontFamily: 'Playfair Display', fontSize: '1.1rem' }),
                text2: createTextObj("We, the Management, Principal, Staff and Students of", { fontFamily: 'Playfair Display', fontSize: '1.1rem', fontWeight: 'bold' }),
                school: createTextObj("Podar International School, AMBEGAON", { fontFamily: 'Cinzel', fontSize: '1.5rem', color: '#581c87' }),
                invite: createTextObj("Invite our young artists to reveal their true self and connect with others, explore the exquisite pieces and leap into the world of artistic expression through the", { fontFamily: 'Playfair Display', fontSize: '1.1rem' }),
                competitionName: createTextObj("PODAR PUNE HUB 1 ART COMPETITION", { fontFamily: 'Cinzel', fontSize: '1.8rem', color: '#312e81', fontWeight: 'bold' }),
                year: createTextObj("2025-26", { fontFamily: 'Cinzel', fontSize: '1.5rem', fontWeight: 'bold' }),
                slogan: createTextObj("‘MASTERS STROKES’", { fontFamily: 'Great Vibes', fontSize: '3rem', color: '#6b21a8' })
            },
            details: {
                bgUrl: "", 
                bgType: "image",
                title: createTextObj("Event Details", { fontFamily: 'Cinzel', fontSize: '2rem', textDecoration: 'underline', fontWeight: 'bold' }),
                dateLabel: createTextObj("Date :", { fontWeight: 'bold' }), date: createTextObj("22nd December, 2025", {}),
                dayLabel: createTextObj("Day :", { fontWeight: 'bold' }), day: createTextObj("Monday", {}),
                timeLabel: createTextObj("Time :", { fontWeight: 'bold' }), time: createTextObj("9:00 am to 4:00 pm", {}),
                venueLabel: createTextObj("Venue :", { fontWeight: 'bold' }), venue: createTextObj("PIS, AMBEGAON", {}),
                scheduleTitle: createTextObj("Schedule of the day", { fontFamily: 'Cinzel', fontSize: '1.5rem', textDecoration: 'underline', marginTop: '2rem' }),
                schedule: [
                    createTextObj("9:00 am – 9:30 am – Breakfast"),
                    createTextObj("9:30 am – 10:00 am – Inauguration"),
                    createTextObj("10:00 am – 1:00 pm – Competition"),
                    createTextObj("1:00 pm – 2:00 pm – Lunch"),
                    createTextObj("2:00 pm – 3:30 pm – Prize Distribution")
                ]
            },
            rules: {
                bgUrl: "", 
                bgType: "image",
                title: createTextObj("Rules and Regulations", { fontFamily: 'Cinzel', fontSize: '2rem', textDecoration: 'underline', fontWeight: 'bold' }),
                items: [
                    createTextObj("1. The 3 best Artworks will be selected from each Grade."),
                    createTextObj("2. The following winners will be announced per Grade:"),
                    createTextObj("   * 1st Prize"),
                    createTextObj("   * 2nd Prize"),
                    createTextObj("   * 3rd Prize"),
                    createTextObj("3. The painting must be relevant to the given theme."),
                    createTextObj("4. A3 size paper will be provided by the host school. Paper Plates will be provided for Warli Painting."),
                    createTextObj("5. Use of reference images and tracing of pictures is not allowed for the participants.")
                ]
            },
            general: {
                bgUrl: "",
                bgType: "image",
                title: createTextObj("General Instructions", { fontFamily: 'Cinzel', fontSize: '2rem', textDecoration: 'underline', fontWeight: 'bold' }),
                sections: [
                    {
                        title: createTextObj("Registration:", { color: '#14532d', textDecoration: 'underline', fontWeight: 'bold', fontSize: '1.25rem' }),
                        content: [
                            createTextObj("Registration will be done through the Google form link shared on Website."),
                            createTextObj("Registration to be completed by 22nd December, 2025.")
                        ]
                    },
                    {
                        title: createTextObj("Adherence:", { color: '#14532d', textDecoration: 'underline', fontWeight: 'bold', fontSize: '1.25rem' }),
                        content: [
                            createTextObj("Follow deadlines, instructions and reporting time."),
                            createTextObj("Every school should send Art teachers with the students (10:1)"),
                            createTextObj("Kindly inform the names of participants prior. Only one student PER GRADE PER SCHOOL will be allowed to participate.")
                        ]
                    },
                    {
                        title: createTextObj("Dress Code:", { color: '#14532d', textDecoration: 'underline', fontWeight: 'bold', fontSize: '1.25rem' }),
                        content: [
                            createTextObj("Students should wear school uniform."),
                            createTextObj("It is mandatory for students and Art Teachers to carry their ID Cards.")
                        ]
                    },
                    {
                        title: createTextObj("Discipline:", { color: '#14532d', textDecoration: 'underline', fontWeight: 'bold', fontSize: '1.25rem' }),
                        content: [
                            createTextObj("All participants must maintain discipline and decorum throughout the school campus.")
                        ]
                    },
                    {
                        title: createTextObj("Refreshment:", { color: '#14532d', textDecoration: 'underline', fontWeight: 'bold', fontSize: '1.25rem' }),
                        content: [
                            createTextObj("Breakfast, lunch and evening snacks will be arranged by the host school.")
                        ]
                    },
                    {
                        title: createTextObj("Judges Decision:", { color: '#14532d', textDecoration: 'underline', fontWeight: 'bold', fontSize: '1.25rem' }),
                        content: [
                            createTextObj("The decision of the judges will be final and binding.")
                        ]
                    }
                ]
            },
            judgement: {
                bgUrl: "",
                bgType: "image",
                title: createTextObj("Judgement Criteria", { fontFamily: 'Cinzel', fontSize: '2rem', textDecoration: 'underline', fontWeight: 'bold' }),
                criteria: [
                    createTextObj("1. Creativity ( Use of theme in the art work )"),
                    createTextObj("2. Colour Scheme"),
                    createTextObj("3. Presentation ( Neatness and Sharpness )"),
                    createTextObj("4. Composition ( Use of space in the sheet )")
                ],
                quote: createTextObj("“Unleash Your Creativity, For Art Knows No Boundaries”", { fontFamily: 'Great Vibes', fontSize: '2rem', color: '#713f12', borderTop: '2px solid #eab308', paddingTop: '1rem', marginTop: '2rem' })
            },
            registration: {
                bgUrl: "", bgType: "image", 
                deadline: createTextObj("26th August 2024", { color: '#b91c1c', fontWeight: 'bold' }), 
                regLink: "https://docs.google.com/forms", 
                disclaimer: createTextObj("*This is a sample link. Replace with your actual Google Form or Excel link.", { fontSize: '0.8rem', fontStyle: 'italic' })
            },
            contact: {
                bgUrl: "", bgType: "image",
                contacts: [
                    { 
                        name: createTextObj("Mr. Anil Patil", { fontWeight: 'bold', fontSize: '1.1rem' }), 
                        role: createTextObj("PIS, Ambegaon", { color: '#991b1b' }), 
                        phone: createTextObj("8421388999", { fontWeight: 'bold', textDecoration: 'underline' }) 
                    }, 
                    { 
                        name: createTextObj("Mr. Ganesh Patil", { fontWeight: 'bold', fontSize: '1.1rem' }), 
                        role: createTextObj("PIS, Ambegaon", { color: '#991b1b' }), 
                        phone: createTextObj("9881739014", { fontWeight: 'bold', textDecoration: 'underline' }) 
                    }
                ]
            }
        };

        // --- COMPONENTS ---

        const TextToolbar = ({ style, onStyleChange }) => {
            const fonts = [
                { name: 'Cinzel', val: 'Cinzel' },
                { name: 'Playfair', val: 'Playfair Display' },
                { name: 'Cursive', val: 'Great Vibes' },
                { name: 'Dance', val: 'Dancing Script' },
                { name: 'Modern', val: 'Montserrat' },
                { name: 'Serif', val: 'serif' },
                { name: 'Sans', val: 'sans-serif' }
            ];

            const sizes = ['0.8rem', '1rem', '1.25rem', '1.5rem', '2rem', '3rem', '4rem', '5rem', '6rem', '8rem'];

            return (
                <div className="format-toolbar">
                    {/* Font Family */}
                    <select 
                        value={style.fontFamily || 'inherit'} 
                        onChange={(e) => onStyleChange({ ...style, fontFamily: e.target.value })}
                        className="bg-gray-700 text-white text-xs rounded border border-gray-600 p-1 outline-none w-20"
                    >
                        <option value="inherit">Font</option>
                        {fonts.map(f => <option key={f.val} value={f.val}>{f.name}</option>)}
                    </select>

                    {/* Font Size */}
                    <select 
                        value={style.fontSize || 'inherit'} 
                        onChange={(e) => onStyleChange({ ...style, fontSize: e.target.value })}
                        className="bg-gray-700 text-white text-xs rounded border border-gray-600 p-1 outline-none w-16"
                    >
                        <option value="inherit">Size</option>
                        {sizes.map(s => <option key={s} value={s}>{s}</option>)}
                    </select>

                    {/* Bold */}
                    <button 
                        onMouseDown={e => e.preventDefault()}
                        onClick={() => onStyleChange({ ...style, fontWeight: style.fontWeight === 'bold' ? 'normal' : 'bold' })}
                        className={`p-1 rounded ${style.fontWeight === 'bold' ? 'bg-purple-600 text-white' : 'text-gray-300 hover:bg-gray-700'}`}
                        title="Bold"
                    >
                        <Icon name="Bold" className="w-3 h-3" />
                    </button>

                     {/* Italic */}
                     <button 
                        onMouseDown={e => e.preventDefault()}
                        onClick={() => onStyleChange({ ...style, fontStyle: style.fontStyle === 'italic' ? 'normal' : 'italic' })}
                        className={`p-1 rounded ${style.fontStyle === 'italic' ? 'bg-purple-600 text-white' : 'text-gray-300 hover:bg-gray-700'}`}
                        title="Italic"
                    >
                        <Icon name="Italic" className="w-3 h-3" />
                    </button>

                    {/* Color Picker */}
                    <div className="relative w-6 h-6 rounded-full overflow-hidden border border-gray-500 cursor-pointer hover:scale-110 transition-transform">
                         <input 
                            type="color" 
                            value={style.color || '#000000'} 
                            onChange={(e) => onStyleChange({ ...style, color: e.target.value })}
                            className="absolute -top-2 -left-2 w-10 h-10 p-0 m-0 cursor-pointer"
                        />
                    </div>
                </div>
            );
        };

        const EditableText = ({ data, onChange, className, multiline = false, admin }) => {
            const text = typeof data === 'object' ? data.text : (data || "");
            const style = typeof data === 'object' ? (data.style || {}) : {};

            if (!admin) return <div className={className} style={style} dangerouslySetInnerHTML={{__html: text.replace(/\n/g, '<br/>')}}></div>;

            return (
                <div className={`editable-wrapper group ${className}`}>
                    <TextToolbar style={style} onStyleChange={(newStyle) => onChange({ text, style: newStyle })} />
                    {multiline ? 
                        <textarea value={text} onChange={(e) => onChange({ text: e.target.value, style })} className="editable-input admin-active p-1 rounded" style={style} rows={3}/> : 
                        <input type="text" value={text} onChange={(e) => onChange({ text: e.target.value, style })} className="editable-input admin-active p-1 rounded" style={style}/>
                    }
                </div>
            );
        };

        // --- POPUP MESSAGE ---
        const PopupMessage = ({ msg, type, onClose }) => {
            if (!msg) return null;
            const bgClass = type === 'error' ? 'bg-red-50 border-red-500 text-red-700' : 'bg-green-50 border-green-500 text-green-700';
            const iconName = type === 'error' ? 'Alert' : 'Check';
            
            return (
                <div className={`fixed top-24 left-1/2 transform -translate-x-1/2 z-[100] px-6 py-4 rounded-lg shadow-2xl border-l-4 flex items-center gap-4 ${bgClass} min-w-[300px] animate-fadeIn`}>
                    <Icon name={iconName} className="w-6 h-6"/>
                    <div className="flex-grow">
                        <p className="font-bold">{type === 'error' ? 'Attention' : 'Success'}</p>
                        <p className="text-sm opacity-90">{msg}</p>
                    </div>
                    <button onClick={onClose} className="hover:opacity-70"><Icon name="X" className="w-5 h-5"/></button>
                </div>
            );
        };

        const BackgroundControl = ({ data, onUpdate, label, onNotify }) => {
            const [isUploading, setIsUploading] = useState(false);
            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setIsUploading(true);
                try {
                    const filename = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '')}`;
                    const storageRef = storage.ref().child(`artifacts/${APP_ID}/public/media/${filename}`);
                    const snapshot = await storageRef.put(file);
                    const downloadURL = await snapshot.ref.getDownloadURL();
                    onUpdate({ 
                        ...data, 
                        bgUrl: downloadURL, 
                        bgType: file.type.startsWith('video/') ? 'video' : 'image' 
                    });
                    onNotify("File uploaded successfully!", 'success');
                } catch (err) {
                    console.error(err);
                    onNotify("Upload failed. Check console.", 'error');
                } finally {
                    setIsUploading(false);
                }
            };

            const handleUrlChange = (val) => {
                // Auto-detect video
                const isVideo = val.endsWith('.mp4') || val.endsWith('.webm') || val.endsWith('.ogg');
                onUpdate({
                    ...data, 
                    bgUrl: val,
                    bgType: isVideo ? 'video' : 'image' // Auto-switch logic
                });
            };

            const handleTypeChange = (type) => {
                onUpdate({...data, bgType: type});
            };

            return (
                <div className="absolute top-4 right-4 z-50 bg-black/80 p-4 rounded text-white text-sm w-64 shadow-xl border border-purple-500">
                    <h4 className="font-bold mb-2 text-purple-300">Editing: {label.toUpperCase()}</h4>
                    
                    {/* NEW: Type Selector */}
                    <div className="mb-3">
                        <label className="block text-xs text-gray-400 font-bold mb-1">Background Type:</label>
                        <select 
                            value={data.bgType} 
                            onChange={(e) => handleTypeChange(e.target.value)}
                            className="w-full text-black text-xs p-1 rounded"
                        >
                            <option value="image">Image</option>
                            <option value="video">Video</option>
                        </select>
                    </div>

                    <div className="mb-2">
                        <label className="block text-xs text-green-400 font-bold">Upload (Cloud)</label>
                        {isUploading ? <span className="text-xs">Uploading...</span> : <input type="file" onChange={handleFileUpload} className="text-xs"/>}
                    </div>
                    <div>
                        <label className="block text-xs text-blue-400 font-bold">Or URL</label>
                        <input 
                            type="text" 
                            value={data.bgUrl || ''} 
                            onChange={(e) => handleUrlChange(e.target.value)} 
                            placeholder="https://... (.mp4 for videos)"
                            className="w-full text-black text-xs p-1 rounded"
                        />
                    </div>
                </div>
            );
        };

        const BackgroundLayer = ({ url, type }) => {
            const isEmbed = url && (url.includes('embed') || url.includes('player'));
            return (
                <div className="absolute inset-0 z-0 overflow-hidden pointer-events-none">
                    {type === 'video' ? (
                        isEmbed ? (
                            <iframe 
                                src={url} 
                                className="w-full h-full object-cover" 
                                frameBorder="0" 
                                allow="autoplay; encrypted-media" 
                                allowFullScreen
                            ></iframe>
                        ) : (
                            <video autoPlay muted loop playsInline className="w-full h-full object-cover" src={url} />
                        )
                    ) : (
                        <div className="w-full h-full bg-cover bg-center" style={{ backgroundImage: `url(${url})` }} />
                    )}
                </div>
            );
        };

        // --- WRAPPER COMPONENT (Defined Outside App) ---
        // This fixes the focus-loss issue by ensuring the wrapper is a stable component
        const ContentWrapper = ({ children, current, isAdmin, updateSection, label, onNotify }) => {
            const controls = isAdmin && <BackgroundControl data={current} onUpdate={(u) => updateSection(label.id, u)} label={label.label} onNotify={onNotify} />;
            return (
                <div className="relative min-h-[600px] w-full flex flex-col justify-center font-body">
                    <BackgroundLayer url={current.bgUrl} type={current.bgType} />
                    <div className="relative z-10 w-full max-w-6xl mx-auto px-4 py-12">
                        {controls}
                        <div className={`max-w-4xl mx-auto p-8 relative z-10 ${glassClass} text-center`}>{children}</div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('home');
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [isAdmin, setIsAdmin] = useState(false);
            const [notification, setNotification] = useState(null); 
            const [data, setData] = useState(INITIAL_DATA);
            const [user, setUser] = useState(null);
            const [isSaving, setIsSaving] = useState(false);

            const showNotify = (msg, type = 'success') => {
                setNotification({ msg, type });
                setTimeout(() => setNotification(null), 4000);
            };

            useEffect(() => {
                const loader = document.getElementById('initial-loader');
                if(loader) { loader.style.opacity = '0'; setTimeout(() => loader.style.display = 'none', 500); }
                
                if(auth) {
                    auth.signInAnonymously().catch(e => console.error(e));
                    auth.onAuthStateChanged(u => {
                        setUser(u);
                        if (u) {
                            db.doc(`artifacts/${APP_ID}/public/data/${COLLECTION_NAME}/${DOC_ID}`).onSnapshot(snap => {
                                if (snap.exists) setData(prev => ({ ...prev, ...snap.data() }));
                            }, err => {
                                if(err.code === 'permission-denied') {
                                    showNotify("Read-only mode (Permission Denied)", 'error');
                                } else {
                                    showNotify("Live data error: " + err.message, 'error');
                                }
                            });
                        }
                    });
                }
            }, []);

            const updateSection = (section, updates) => setData({ ...data, [section]: { ...data[section], ...updates } });

            const saveChanges = async () => {
                if (!user) return showNotify("Login required to save.", 'error');
                setIsSaving(true);
                try {
                    await db.doc(`artifacts/${APP_ID}/public/data/${COLLECTION_NAME}/${DOC_ID}`).set(data);
                    showNotify("Changes Saved Successfully!", 'success');
                } catch (e) {
                    showNotify("Save failed: " + e.code, 'error');
                } finally {
                    setIsSaving(false);
                }
            };

            const tabColors = { home: 'violet', details: 'indigo', rules: 'blue', general: 'green', judgement: 'yellow', registration: 'orange', contact: 'red' };
            const navItems = [
                { id: 'home', label: 'Home' }, { id: 'details', label: 'Event Details' }, { id: 'rules', label: 'Rules & Regs' },
                { id: 'general', label: 'General Instructions' }, { id: 'judgement', label: 'Judgement Criteria' },
                { id: 'registration', label: 'Registration' }, { id: 'contact', label: 'Contact Us' },
            ];

            const renderContent = () => {
                const current = data[activeTab];
                const activeNavItem = navItems.find(n => n.id === activeTab);

                const commonProps = {
                    current,
                    isAdmin,
                    updateSection,
                    label: activeNavItem,
                    onNotify: showNotify
                };

                if (activeTab === 'home') return <ContentWrapper {...commonProps}>
                    <div className="space-y-6 text-lg">
                        <EditableText admin={isAdmin} data={current.intro} onChange={v => updateSection('home', {intro:v})} />
                        <div className="my-4 leading-loose">
                            <EditableText admin={isAdmin} data={current.quote} onChange={v => updateSection('home', {quote:v})} />
                        </div>
                        <EditableText admin={isAdmin} data={current.text1} onChange={v => updateSection('home', {text1:v})} multiline />
                        <div className="mt-8">
                            <EditableText admin={isAdmin} data={current.text2} onChange={v => updateSection('home', {text2:v})} />
                            <h4 className="my-2 leading-relaxed"><EditableText admin={isAdmin} data={current.school} onChange={v => updateSection('home', {school:v})} /></h4>
                        </div>
                        <EditableText admin={isAdmin} data={current.invite} onChange={v => updateSection('home', {invite:v})} multiline />
                        <div className="mt-8 border-t border-gray-400 pt-6">
                            <h2><EditableText admin={isAdmin} data={current.competitionName} onChange={v => updateSection('home', {competitionName:v})} /></h2>
                            <h3 className="my-2 leading-relaxed"><EditableText admin={isAdmin} data={current.year} onChange={v => updateSection('home', {year:v})} /></h3>
                            <h1 className="mt-4 leading-relaxed"><EditableText admin={isAdmin} data={current.slogan} onChange={v => updateSection('home', {slogan:v})} /></h1>
                        </div>
                    </div>
                </ContentWrapper>;

                if (activeTab === 'details') return <ContentWrapper {...commonProps}>
                    <div className="space-y-6 text-lg">
                        <div className="mb-8"><EditableText admin={isAdmin} data={current.title} onChange={v => updateSection('details', {title:v})} /></div>
                        <div className="grid gap-4 text-xl">
                            {['date', 'day', 'time', 'venue'].map(f => (
                                <div key={f} className="flex flex-col md:flex-row justify-center items-center gap-2">
                                    <EditableText admin={isAdmin} data={current[f+'Label']} onChange={v => updateSection('details', {[f+'Label']:v})} />
                                    <EditableText admin={isAdmin} data={current[f]} onChange={v => updateSection('details', {[f]:v})} />
                                </div>
                            ))}
                        </div>
                        <div className="mt-12">
                            <div className="mb-6"><EditableText admin={isAdmin} data={current.scheduleTitle} onChange={v => updateSection('details', {scheduleTitle:v})} /></div>
                            <ul className="space-y-3">
                                {current.schedule.map((item, idx) => (
                                    <li key={idx} className="flex justify-center items-center relative">
                                        <EditableText admin={isAdmin} data={item} onChange={v => {
                                            const n = [...current.schedule]; n[idx] = v; updateSection('details', {schedule:n});
                                        }} />
                                        {isAdmin && <button onClick={() => { const n = current.schedule.filter((_, i) => i !== idx); updateSection('details', {schedule:n}); }} className="text-red-500 absolute -right-6">[x]</button>}
                                    </li>
                                ))}
                                {isAdmin && <button onClick={() => updateSection('details', {schedule: [...current.schedule, {text:"New Event", style:{}}]})} className="text-xs bg-gray-200 px-2 rounded mt-2">+ Add</button>}
                            </ul>
                        </div>
                    </div>
                </ContentWrapper>;

                if (activeTab === 'rules') return <ContentWrapper {...commonProps}>
                    <div className="space-y-6 text-left text-lg px-4 md:px-12">
                        <div className="mb-8 text-center"><EditableText admin={isAdmin} data={current.title} onChange={v => updateSection('rules', {title:v})} /></div>
                        <ol className="list-none space-y-4">
                            {current.items.map((item, idx) => {
                                const isSubItem = item.text.trim().startsWith('*');
                                return (
                                    <li key={idx} className={`relative ${isSubItem ? 'pl-12 text-base' : 'pl-2'}`}>
                                        <EditableText admin={isAdmin} data={item} onChange={v => {
                                            const n = [...current.items]; n[idx] = v; updateSection('rules', {items:n});
                                        }} multiline className="w-full" />
                                        {isAdmin && <button onClick={() => { const n = current.items.filter((_, i) => i !== idx); updateSection('rules', {items:n}); }} className="absolute -left-6 top-0 text-red-500 text-sm">[x]</button>}
                                    </li>
                                );
                            })}
                            {isAdmin && <button onClick={() => updateSection('rules', {items: [...current.items, {text:"New Rule", style:{}}]})} className="text-xs bg-gray-200 px-2 rounded mt-2">+ Add</button>}
                        </ol>
                    </div>
                </ContentWrapper>;

                if (activeTab === 'general') return <ContentWrapper {...commonProps}>
                    <div className="space-y-8 text-lg">
                        <div className="mb-8"><EditableText admin={isAdmin} data={current.title} onChange={v => updateSection('general', {title:v})} /></div>
                        {current.sections.map((s, i) => (
                            <div key={i} className="border-b border-gray-200 pb-4">
                                <h3><EditableText admin={isAdmin} data={s.title} onChange={v => { const n = [...current.sections]; n[i].title = v; updateSection('general', {sections:n}); }} /></h3>
                                <ul className="space-y-2">
                                    {s.content.map((l, j) => (
                                        <li key={j} className="flex flex-col items-center">
                                            <EditableText admin={isAdmin} data={l} onChange={v => { const n = [...current.sections]; n[i].content[j] = v; updateSection('general', {sections:n}); }} multiline className="w-full text-center" />
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        ))}
                    </div>
                </ContentWrapper>;

                if (activeTab === 'judgement') return <ContentWrapper {...commonProps}>
                    <div className="space-y-8 text-lg">
                        <div className="mb-8"><EditableText admin={isAdmin} data={current.title} onChange={v => updateSection('judgement', {title:v})} /></div>
                        <ol className="list-none space-y-6 text-xl">
                            {current.criteria.map((item, idx) => (
                                <li key={idx}><EditableText admin={isAdmin} data={item} onChange={v => { const n = [...current.criteria]; n[idx] = v; updateSection('judgement', {criteria:n}); }} /></li>
                            ))}
                        </ol>
                        <div className="mt-8"><EditableText admin={isAdmin} data={current.quote} onChange={v => updateSection('judgement', {quote:v})} /></div>
                    </div>
                </ContentWrapper>;

                if (activeTab === 'registration' || activeTab === 'contact') return <ContentWrapper {...commonProps}>
                    {activeTab === 'registration' ? (
                        <div>
                            <div className="text-xl mb-4">Register by: <EditableText admin={isAdmin} data={current.deadline} onChange={v => updateSection('registration', {deadline:v})} /></div>
                            {isAdmin && <input className="w-full p-2 border mb-2 text-black" value={current.regLink} onChange={e => updateSection('registration', {regLink: e.target.value})} />}
                            <a href={current.regLink} target="_blank" className="block w-full bg-green-600 text-white font-bold py-4 rounded-lg">Register Online</a>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto">
                            {current.contacts.map((c, i) => (
                                <div key={i} className="relative group bg-white/80 backdrop-blur-sm p-6 rounded-2xl shadow-xl border border-red-100 flex flex-col items-center text-center transition-all duration-300 hover:shadow-2xl hover:-translate-y-1">
                                    {isAdmin && (
                                        <button 
                                            onClick={() => { const n = current.contacts.filter((_, idx) => idx !== i); updateSection('contact', {contacts:n}); }} 
                                            className="absolute top-2 right-2 p-2 text-red-400 hover:text-red-600 bg-red-50 rounded-full"
                                        >
                                            <Icon name="X" className="w-4 h-4"/>
                                        </button>
                                    )}
                                    
                                    <div className="w-20 h-20 bg-gradient-to-tr from-red-100 to-orange-100 rounded-full flex items-center justify-center mb-4 shadow-inner">
                                        <Icon name="User" className="w-10 h-10 text-red-500" />
                                    </div>

                                    <div className="w-full mb-2">
                                        <div className="text-2xl font-bold text-gray-800 font-title">
                                            <EditableText admin={isAdmin} data={c.name} onChange={v => { const n = [...current.contacts]; n[i].name = v; updateSection('contact', {contacts:n}); }} />
                                        </div>
                                    </div>

                                    <div className="flex items-center justify-center gap-2 text-red-600 font-medium mb-4 w-full">
                                        <Icon name="Briefcase" className="w-4 h-4" />
                                        <EditableText admin={isAdmin} data={c.role} onChange={v => { const n = [...current.contacts]; n[i].role = v; updateSection('contact', {contacts:n}); }} />
                                    </div>

                                    <div className="mt-auto w-full pt-4 border-t border-red-100">
                                        <div className="flex items-center justify-center gap-2 text-lg font-bold text-gray-700 bg-red-50 py-2 rounded-lg group-hover:bg-red-600 group-hover:text-white transition-colors duration-300">
                                            <Icon name="Phone" className="w-5 h-5" />
                                            <EditableText admin={isAdmin} data={c.phone} onChange={v => { const n = [...current.contacts]; n[i].phone = v; updateSection('contact', {contacts:n}); }} />
                                        </div>
                                    </div>
                                </div>
                            ))}
                            
                            {isAdmin && (
                                <button 
                                    onClick={() => updateSection('contact', {contacts: [...current.contacts, {
                                        name: {text:"New Contact", style:{}}, 
                                        role: {text:"Role/Position", style:{}}, 
                                        phone: {text:"+91 0000000000", style:{}}
                                    }]})}
                                    className="flex flex-col items-center justify-center p-6 border-2 border-dashed border-red-300 rounded-2xl bg-red-50/50 hover:bg-red-50 transition-all text-red-400 font-bold gap-2 min-h-[300px]"
                                >
                                    <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center">
                                        <Icon name="Plus" className="w-8 h-8"/>
                                    </div>
                                    <span>Add New Contact</span>
                                </button>
                            )}
                        </div>
                    )}
                </ContentWrapper>;
                return null;
            };

            const getColorClass = (color, isActive) => {
                const colors = {
                    violet: 'violet', indigo: 'indigo', blue: 'blue', green: 'green', yellow: 'yellow', orange: 'orange', red: 'red'
                };
                const c = colors[color];
                if (isActive) return `bg-${c}-600 text-white shadow-lg scale-105 z-10`;
                return `text-${c}-600 bg-${c}-100 hover:bg-${c}-200 opacity-90`;
            };

            return (
                <div className="min-h-screen bg-gray-100 font-sans flex flex-col">
                    <PopupMessage msg={notification?.msg} type={notification?.type} onClose={() => setNotification(null)} />

                    <header className="relative min-h-[60vh] h-auto py-20 flex items-center justify-center overflow-hidden bg-gray-900">
                        <div className="absolute inset-0 bg-black/50 z-10" />
                        <BackgroundLayer url={data.header.bgUrl} type={data.header.bgType} />
                        {isAdmin && <BackgroundControl data={data.header} onUpdate={(u) => updateSection('header', u)} label="Main Header" onNotify={showNotify} />}
                        <div className="relative z-20 text-center text-white px-4">
                            <h2 className="mb-2"><EditableText admin={isAdmin} data={data.header.schoolName} onChange={v => updateSection('header', {schoolName:v})} className="bg-transparent" /></h2>
                            <h1 className="mb-4"><EditableText admin={isAdmin} data={data.header.title} onChange={v => updateSection('header', {title:v})} className="bg-transparent" /></h1>
                            <p><EditableText admin={isAdmin} data={data.header.subtitle} onChange={v => updateSection('header', {subtitle:v})} className="bg-transparent" /></p>
                        </div>
                    </header>

                    <nav className="sticky top-0 z-40 bg-white shadow-lg">
                        <div className="flex justify-center flex-wrap">
                            {navItems.map(item => (
                                <button key={item.id} onClick={() => setActiveTab(item.id)} className={`px-4 py-3 font-bold uppercase text-xs transition-all duration-300 ${getColorClass(tabColors[item.id], activeTab === item.id)}`}>
                                    {item.label}
                                </button>
                            ))}
                        </div>
                    </nav>

                    <main className="w-full flex-grow">{renderContent()}</main>

                    <footer className="bg-gray-900 text-white py-8 text-center relative">
                        <div className="flex justify-center gap-4 mt-4">
                            <button onClick={() => { if(isAdmin) saveChanges(); setIsAdmin(!isAdmin); }} className={`flex items-center gap-2 px-4 py-2 rounded text-xs font-bold ${isAdmin ? 'bg-red-600' : 'bg-gray-700'}`}>
                                {isAdmin ? <Icon name="Unlock" className="w-3 h-3"/> : <Icon name="Lock" className="w-3 h-3"/>}
                                {isAdmin ? 'Exit Admin & Save' : 'Admin Login'}
                            </button>
                            {isAdmin && <button onClick={saveChanges} className="px-4 py-2 bg-green-600 rounded text-xs font-bold">{isSaving ? 'Saving...' : 'Save Changes'}</button>}
                        </div>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
